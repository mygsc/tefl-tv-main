
/****
* This video player is not compatible for EI browser :( sorry
* Author by: G-rald Burasca
* wanna know more about me just visit my site at w3.geraldburasca.com (coming soooon.........)
* feel free to contact me -> gerald.burasca27@gmail.com
* Created on Feb. 2015 - present
* use strict"; 
****/
document.addEventListener("DOMContentLoaded", main, false);
$('#controls').hide();$('#ads-hide').hide();$('#loader').fadeIn(); 
var videoplayer = {
	volume       : 1,
	fullscreen   : false,
	videoQuality : function(e){
		return this.volume;
	}
};
$(document).ready(function(){
	$('#controls').fadeIn();
	$('#loader').fadeOut();
	if(autoplay == 1){
		document.getElementById('media-video').play();
		incView(filename);
		adsLine();
	}
});
var mediaPlayer, seen = false,  duration = $('#duration').val(), autoplay = $('#autoplay').val(), filename = $('#filename').val(), percentageloaded, handle, timeout, progressHandle=false, hideControls = false, mouseOverPlayer =false, progWidth, mp4, webm, vidMp4Src, vidWebmSrc, buffPercent, percentLoaded, loader, progress, hrs=0, mins=0, secs=0, tmpSecs=0, adsTime = 10, ads=0, vidMinLenght=0, vidSecLenght=0, videoCurrentTime=0,playPauseBtn, timeDuration=0,muteBtn, playIcon = false, replay, _time, curHrs, curMin, curSec, durHrs, durMin, durSec,progressBar, soundHover = false, volumeHover = false, currentTime=0, videoPlaying = false, start = false, error = false,videoTimeLenght,volumes=0, volumeClick = false, mouseX = 0, mouseY = 0, volumeY=0, volumeDrag = false, progressbarClick = false,updProgWidth = 0, videoControls, volumeStatus, bufferedAmount, currentBuffered, currentProgress, playBtn, play, seekSlider,highQual,normalQual, lowQual, fullscreenVid, mouseMoving=false,videoQuality = {'9001p':'highres', '1080p':'hd1080', '720p':'hd720', '480p':'large', '360p':'medium', '240p':'small', '144p':'tiny'};
var errorMsg = 'An error occured please try again later.';
var vidMsg = 'Video is not ready please try again later.';
var notifyMsg = 'Your video is saved we will notify you when your video is ready to watch.';
var connectionMsg = 'You have no internet connection.';

function main(){
	mp4 = document.getElementById('mp4');
	webm = document.getElementById('webm');
	vidMp4Src = mp4.src;
	vidWebmSrc = webm.src;
	vidMp4Src = vidMp4Src.replace('.mp4','');
	vidWebmSrc = vidWebmSrc.replace('.webm','');
	loader = document.getElementById('loader');
	seekSlider = document.getElementById('seek-slider');
	highQual = document.getElementById('high-quality');
	normalQual = document.getElementById('normal-quality');
	lowQual = document.getElementById('low-quality');
	mediaPlayer = document.getElementById('media-video');
	videoControls = document.getElementById('vid-controls');
	playPauseBtn = document.getElementById('play-pause');
	muteBtn = document.getElementById('mute-icon');
	bufferedAmount = document.getElementById('buffered');
	currentProgress =  document.getElementById('current-progress');
	videoTimeLenght = document.getElementById('video-time-lenght');
	volumeStatus = document.getElementById('volume');
	_time = document.getElementById('time');
	fullscreenVid =  document.getElementById('fullscreen');
	progWidth = document.getElementById('progressbar').offsetWidth;
	progress = document.getElementById('current-progress').offsetWidth;
	play = document.getElementById('play-icon');
	mediaPlayer.controls = false;
	playPauseBtn.addEventListener('click',togglePlayPause, false);
	muteBtn.addEventListener('click',toggleMute, false);
	highQual.addEventListener('click',highQuality, false);
	normalQual.addEventListener('click',normalQuality, false);
	lowQual.addEventListener('click',lowQuality, false);
	bufferedAmount.addEventListener('click',vidSeek, false);
	seekSlider.addEventListener('change',vidSeek, false);
	$(normalQual).css({'color':'#fc8b02'});
	mediaPlayer.addEventListener('timeupdate', seekTimeUpdate, false); //updateProgressBar
	
	mediaPlayer.addEventListener('play', function() {
		changeButtonType(playPauseBtn, 'player pause', 'Pause');
	}, false);

	mediaPlayer.addEventListener('pause', function() {
		changeButtonType(playPauseBtn, 'player play', 'Play');
	}, false);
	
	mediaPlayer.addEventListener('volumechange', function(e){ 
		if (mediaPlayer.muted) {changeButtonType(muteBtn, 'player sound-off', 'Unmute');}
		else {changeButtonType(muteBtn, 'player sound-on', 'Mute'); }
	}, false);	

	mediaPlayer.addEventListener('ended', function(){ 
		$('.play-icon').fadeIn(500);
		$(loader).fadeOut();
		videoPlaying = false;
	}, false);

	mediaPlayer.addEventListener('loadedmetadata', metadata, false);
	fullscreenVid.addEventListener('click', toggleFullScreen, false); //fullscreen toggleFullScreen
	volumeStatus.addEventListener('change', setVolume, false);
	mediaPlayer.addEventListener('error', hasError, false);
	mediaPlayer.addEventListener('canplay', canPlayVid, true);
	mediaPlayer.addEventListener('canplaythrough', canPlayVid, false);
}
function metadata(){
	timeDuration = Math.round(mediaPlayer.duration);
	timeSettings();
}
function checkInternet(){
	var online = navigator.onLine;
	return online;
}

function loadBuffer(){
	if(mediaPlayer.buffered.length > 0){
		buffPercent = mediaPlayer.buffered.end(0);
		percentLoaded = Math.floor((buffPercent / mediaPlayer.duration) * 100);
		$('#buffered').css({'width': percentLoaded + '%'});
	}
	if(Math.round(updProgWidth) >= percentLoaded){
			$('.play-icon').fadeOut();
			$('#loader').fadeIn();
	 }
	//else{
	// 		$('#loader').fadeOut();
	// 	}

	// if(mediaPlayer.networkState === mediaPlayer.NETWORK_LOADING){
	// 	$('.play-icon').fadeOut();
	// 	$(loader).fadeIn();
	//    }
	// else{
	//    	 $(loader).fadeOut();
	//    }
	// if(mediaPlayer.networkState === mediaPlayer.HAVE_ENOUGH_DATA){
	//    	$('#loader').fadeIn();$('.play-icon').fadeOut();
	//    }
	// else{
	//     	$('#loader').fadeOut();
	//   }
	
}
function canPlayVid() { 
	$(loader).fadeOut();
	loadBuffer();
}
function onWaitingBuffer() { 
	
}
function hasError(){
	$('#error-video').html(errorMsg).css({'color':'#fff'});
}
function seekingNewPosition() { //find new position
	var seekTo = mediaPlayer.duration * (seekSlider.value / 100);
	mediaPlayer.currentTime = seekTo;
}

function changeVidQuality(mp4Ext,webmExt,oggExt){
	videoCurrentTime = mediaPlayer.currentTime;
	$('#error-video').fadeIn();
	$('#error-video').html('Please wait...').css({'color':'#fff','text-align':'center'});
	var newSrc;
	newSrc = vidMp4Src+mp4Ext;mp4.setAttribute('src', newSrc);
	newSrc = vidWebmSrc+webmExt;webm.setAttribute('src', newSrc);
	//newSrc = vidOggSrc+oggExt;ogg.setAttribute('src', newSrc);
	if(mediaPlayer.canPlayType("video/mp4")){
		mp4.addEventListener('error', checkVideo, false);
	}else if(mediaPlayer.canPlayType("video/webm")){
		webm.addEventListener('error', checkVideo, false);
	}
	 //else if(mediaPlayer.canPlayType("video/ogg")){
	// 	ogg.addEventListener('error', checkVideo, false);
	// }
	mediaPlayer.pause(); mediaPlayer.load(); mediaPlayer.currentTime=videoCurrentTime; mediaPlayer.play();
	mediaPlayer.addEventListener('canplaythrough', function(){
		$('#error-video').fadeOut();
	},false);
	mediaPlayer.addEventListener('canplay', function(){
		$('#error-video').fadeOut();
	}, false);

}
function highQuality(e){
	e.preventDefault();$('#play-icon').fadeOut('fast');$(loader).fadeIn('fast');$(highQual).css({'color':'#fc8b02'});$(normalQual).css({'color':'#fff'});$(lowQual).css({'color':'#fff'});
	changeVidQuality('_hd.mp4','_hd.webm','_hd.ogg');
	//var isOpera = !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0, isFirefox = typeof InstallTrigger !== 'undefined', isSafari = Object.prototype.toString.call(window.HTMLElement).indexOf('Constructor') > 0, isChrome = !!window.chrome && !isOpera, isIE = /*@cc_on!@*/false || !!document.documentMode;  
}
function normalQuality(e){
	e.preventDefault();$('#play-icon').fadeOut('fast');$(loader).fadeIn('fast');$(highQual).css({'color':'#fff'});$(normalQual).css({'color':'#fc8b02'});$(lowQual).css({'color':'#fff'});
	changeVidQuality('.mp4','.webm','.ogg');
}
function lowQuality(e){
	e.preventDefault();$('#play-icon').fadeOut('fast');$(loader).fadeIn('fast');$(highQual).css({'color':'#fff'});$(normalQual).css({'color':'#fff'});$(lowQual).css({'color':'#fc8b02'});
	changeVidQuality('_low.mp4','_low.webm','_low.ogg');
}
function checkVideo(){
	$(loader).fadeOut('fast');
	$('#error-video').html(vidMsg).css({'color':'#fff'});
}
function hideLoader(){
	$(loader).fadeIn();
}
function vidSeek(){
	var seekTo = mediaPlayer.duration * (seekSlider.value / 100);
	mediaPlayer.currentTime = seekTo;
}
function seekTimeUpdate(){
	updProgWidth = mediaPlayer.currentTime * (100 / mediaPlayer.duration);
	$('#current-progress').css({'width' : updProgWidth + '%', 'position' : 'relative'});
	handle = Math.floor(updProgWidth / mediaPlayer.duration * progWidth);
	$('#button-progress').css({'left' : '99%', 'position' : 'absolute'});
	var currentSeek = mediaPlayer.currentTime * (100 / mediaPlayer.duration);
	seekSlider.value = currentSeek;
	curHrs = Math.floor(mediaPlayer.currentTime / 3600);
	curMin = Math.floor(mediaPlayer.currentTime / 60);
	curSec = Math.floor(mediaPlayer.currentTime - (curMin * 60));
	durHrs = Math.floor(curMin / 60);
	durMin = Math.floor(mediaPlayer.duration / 60);
	durSec = Math.floor(mediaPlayer.duration - (durMin  * 60));
	if(curSec < 10){curSec = "0"+curSec;}
	if(durSec < 10){durSec = "0"+durSec;}
	_time.innerHTML = curHrs + ':' + curMin + ':' + curSec + '/' + durHrs + ':' + durMin + ':' +durSec;
	if(timeDuration >= 3600){
		_time.innerHTML = curHrs + ':' + curMin + ':' + curSec + '/' + durHrs + ':' + durMin + ':' +durSec;
	}else{
		_time.innerHTML = curMin + ':' + curSec + '/' + durMin + ':' +durSec;
	}
	if(Math.floor(mediaPlayer.currentTime) == adsTime){
		$('.advertisement').fadeIn(1000);
	}
	checkVid();
	loadBuffer();
	
}

function checkVid(){
	if(isNaN(durSec)){
		$('.ctime').html('');
		$('#error-video').html(vidMsg).css({'color':'#fff','text-align':'center'});
		$('#error-video').fadeIn();	
		$(loader).fadeOut('fast');	
		seekSlider.value=0;
		setTimeout(function(){
			$('#error-video').fadeOut();	
			// $('#error-video').html('');
		}, 5000);
	}else{
		$(loader).fadeOut('fast');
	}
}

function toggleFullScreen() {
  if (!document.fullscreenElement &&    // alternative standard method
      !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement ) {  // current working methods
  	if (mediaPlayer.requestFullscreen) {
  		mediaPlayer.requestFullscreen();
  	} else if (mediaPlayer.msRequestFullscreen) {
  		mediaPlayer.msRequestFullscreen();
  	} else if (mediaPlayer.mozRequestFullScreen) {
  		videoControls.mozRequestFullScreen();
  	} else if (mediaPlayer.webkitRequestFullscreen) {
  		mediaPlayer.webkitRequestFullscreen();
      //mediaPlayer.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
      //videoFullScreen.request(document.getElementById('media-video'));
  }
} else {
	if (document.exitFullscreen) {
		document.exitFullscreen();
	} else if (document.msExitFullscreen) {
		document.msExitFullscreen();
	} else if (document.mozCancelFullScreen) {
		document.mozCancelFullScreen();
	} else if (document.webkitExitFullscreen) {
		document.webkitExitFullscreen();
	}
}
}

function adsLine(){

	ads = (adsTime / duration) * 100;
	$('<div class="ads"> <div style="border-radius:2px;z-index:1111;background:yellow;position:absolute;right:0;height:100%;width:5px;"></div></div>').prependTo('#progress-ads-line');
	$('.ads').css({'border-radius':'2px', 'background':'transparent','width': ads + '%', 'height':'100%', 'position':'absolute'});
}
function timeSettings(){
	vidMinLenght = Math.floor(mediaPlayer.duration / 60);
	vidSecLenght = Math.floor(mediaPlayer.duration - (vidMinLenght * 60));
	hrs = Math.floor(vidMinLenght / 60);
	mins =  (vidMinLenght - (hrs * 60));
	secs =   Math.floor(mediaPlayer.duration - (vidMinLenght * 60));
	if(secs < 10) { secs = '0'+ secs; }
	if(vidSecLenght < 10) { vidSecLenght = '0'+ vidSecLenght; }
	if(mins < 10) { mins = '0'+ mins; }
	if(hrs < 10) { hrs = '0'+ hrs; }
	if(timeDuration < 3600){
		$('.ctime').html(vidMinLenght + ':' + vidSecLenght);
	}else{
		$('.ctime').html(hrs + ':' + mins + ':' + secs);
	}
	
}
function toggleShowHanldeProgress(){
	// if(mediaPlayer.paused || mediaPlayer.ended){
	// 	$('#button-progress').fadeIn();
	// }else{
	// 	$('#button-progress').fadeOut();
	// }
}
function togglePlayPause(){
	if (mediaPlayer.paused || mediaPlayer.ended) {
		toggleShowHanldeProgress();
		changeButtonType(playPauseBtn, 'player pause', 'Pause');
		mediaPlayer.play();
		videoPlaying = true;
		playIcon = false;
		$('.play-icon').fadeOut(500);
	}else {
		changeButtonType(playPauseBtn, 'player play','Play');
		toggleShowHanldeProgress();
		mediaPlayer.pause();
		videoPlaying = false;
		playIcon=true;
		$('.play-icon').fadeIn(500);
		
	}
}

function stopPlayer() {
	mediaPlayer.pause();
	mediaPlayer.currentTime = 0;
}
function setVolume(){
	mediaPlayer.volume = volumeStatus.value / 100;
}
function toggleMute() {
	if (mediaPlayer.muted) {
		changeButtonType(muteBtn, 'player sound-on','Mute');
		mediaPlayer.muted = false;
		volumeStatus.value = 100; 
	}
	else {
		changeButtonType(muteBtn,'player sound-off', 'Unmute');
		mediaPlayer.muted = true;
		volumeStatus.value = 0;	
	}
}

function replayMedia() {
	resetPlayer();
	mediaPlayer.play();
}

function changeButtonType(btn, toggleclass, title) {
	btn.title = title;
	btn.className = toggleclass;
}

function loadVideo() {
	for (var i = 0; i < arguments.length; i++) {
		var file = arguments[i].split('.');
		var ext = file[file.length - 1];
		// Check if this media can be played
		if (canPlayVideo(ext)) {
			// Reset the player, change the source file and load it
			resetPlayer();
			mediaPlayer.src = arguments[i];
			mediaPlayer.load();
			break;
		}
	}
}
function canPlayVideo(ext) {
	var ableToPlay = mediaPlayer.canPlayType('video/' + ext);
	if (ableToPlay == '') return false;
	else return true;
}
function resetPlayer() {
	progress = 0;
	mediaPlayer.currentTime = 0;
	changeButtonType(playPauseBtn, 'player play', 'Play');
}
function fullscreen(){
	videoFullScreen.request(document.getElementById('media-video'));
//screenfull.request($('.wrapper')[0]);		
}
function videoForwardBackward(e){
	mouseX = e.pageX - $('#current-progress').offset().left;
	currentTime = (Math.floor(mouseX) /  Math.floor(progWidth)) * Math.floor(mediaPlayer.duration);
	mediaPlayer.currentTime = currentTime;
}
function timeoutMouseMove(milliseconds){
	clearTimeout(timeout);
	timeout = setTimeout(function(){$('#controls').fadeOut(500);$('#ads-hide').css({'bottom':'0px'});}, milliseconds);
}
function LetProcessYourVolume(e){
	volumeClick = true;
	mouseY = $('.volume-static-holder').height() - (e.pageY - $('.volume-static-holder').offset().top);
	if(mouseY < 0 || mouseY > $(this).height()) {
		volumeClick = false;
		return false;
	}
	$('#volume-vertical').css({'height' : mouseY+'px'});
	$('#volume-button').css({'top' : (mouseY-($('#volume-button').height()/2))+'px'});
	mediaPlayer.volume = $('#volume-vertical').height() / $(this).height();
	volumeY = $('#volume-vertical').height() / $(this).height();
	if($('#volume-vertical').height() < 15){
		$('#volume-button').css({'background':'red'});
		$('#volume-vertical').css('overflow','hidden');
	}else{
		$('#volume-button').css('background','#fff');
	}
}
function incView(filename){
	if(seen == false){
		seen = true;
		setTimeout(function(){
			$.ajax({
				url  	: 'v/increment-view/'+filename,
				type 	:'POST',
				data 	: {},
				success : function(e){
					console.log('view plus one');
				},
				error   : function(e){
					console.log('It has an error.');
				}
			});
		},7000);
	}
}
$('#media-video').bind("contextmenu", function(){
	return false;
});
$('#media-video').bind('ended', function(){
	if(!this.paused) this.pause();
	$(loader).fadeOut();
});
$('#media-video').bind('progress', function(){
	loadBuffer();
});
$('#media-video').bind('loadeddata', function(){
	loadBuffer();
	
});
$('#media-video').bind('canplaythrough', function(){
	loadBuffer();
});
$('#media-video').bind('playing', function(){
	loadBuffer();
});
$('#media-video').bind('error', function(){
	$('#error-video').html(errorMsg).css({'color':'#fff'});
});
$('#mute-icon').hover(function(){
	soundHover=true;
	if(soundHover==true){
		$('.volume').fadeIn(1000);	
		setTimeout(function(){
			$('.volume').fadeOut(500);
		},10000);
	}	
});
$('.volume, .volume-static-holder, #volume-vertical').hover(function(){	
	soundHover=false;
});
$('.volume').mouseleave(function(){
	if(soundHover==false){
		$('.volume').fadeOut(1000);
	}
});

$('#volume-vertical').mousedown(function(e){
	LetProcessYourVolume(e)
});

$('.volume-static-holder').mousedown(function(e){
	LetProcessYourVolume(e);
});
$('#progressbar').bind('mousedown', function(e) {	
	videoForwardBackward(e);	
});
$('#buffered').bind('mousedown', function(e) {	
	videoForwardBackward(e);
});
$(currentProgress).bind('mousedown', function(e) {	
	videoForwardBackward(e);
});
$('#button-progress').mousedown(function(e) {	
	progressHandle = true;
});
$('html, body').mouseup(function(e) {	
	progressHandle = false;
});
$('html, body').mousemove(function(e){
	if(progressHandle==true){
		mouseX = e.pageX - $('#current-progress').offset().left;
		currentTime = (Math.floor(mouseX) /  Math.floor(progWidth)) * Math.floor(mediaPlayer.duration);
		if(currentTime>mediaPlayer.currentTime) {mediaPlayer.currentTime += 2;}
		else {mediaPlayer.currentTime -= 2;}
	}
});

$('#hd-setting').bind('click', function(){
	$('.hd-setting').toggle('show');
	$('.share-video').fadeOut();
});

$('#share-video').bind('click', function(){
	$('.share-video').toggle('show');
	$('.hd-setting').fadeOut();
});

$('.play-icon').bind('click', function(){
	togglePlayPause();
	if(playIcon==false){
		$(this).fadeOut(500);
		playIcon=true;
	}else{$('.play-icon').fadeIn(500);}	
	$('.play-icon').fadeOut(500);
});
$('#media-video').bind('click', function(){
	togglePlayPause();
	if(playIcon==true){
		$('.play-icon').fadeIn(500);
		playIcon=false;
	}else{$('.play-icon').fadeOut(500);playIcon=true;}
});
$('.close').bind('click', function(){
	$('.advertisement').fadeOut(500);
	$('#ads-hide').fadeIn();
});
$('#ads-hide').bind('click', function(){
	$('.advertisement').fadeIn(1000);
	$('#ads-hide').fadeOut();
});
$('#media-video, #controls, .play-icon').mouseover(function(){
	mouseOverPlayer = true;
});
$('#media-video, #controls, .play-icon').mouseleave(function(){
	mouseOverPlayer = false;
});
$('html, body').mousemove(function(){
	if(mouseOverPlayer){$('#controls').fadeIn(500);hideControls=false;}else{$('#controls').fadeOut('fast');hideControls=true;}
	timeoutMouseMove(5000);
	$('#ads-hide').css({'bottom':'50px'});
});

/****
* This video player is not compatible for EI browser :( sorry
* Author by: G-rald Burasca
* wanna know more about me just visit my site at w3.geraldburasca.com (coming soooon.........)
* feel free to contact me gerald.burasca27@gmail.com
* Created on Feb. 2015 - present
****/
